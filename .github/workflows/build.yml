name: Build & Test

on:
  push:
    branches: [ main ]
  pull_request:
    branches: [ main ]

jobs:
  native:
    runs-on: ${{ matrix.os }}
    continue-on-error: true
    strategy:
      fail-fast: false
      matrix:
        os: [macos-13, ubuntu-22.04, windows-2022]
        config: [Release, Debug]
        include:
          - os: macos-13
            platform: macos
          - os: ubuntu-22.04
            platform: linux
          - os: windows-2022
            platform: windows
    steps:
      - uses: actions/checkout@v4
        with:
          submodules: recursive
      - name: Configure git (Windows)
        if: matrix.platform == 'windows'
        shell: pwsh
        run: git config --global core.longpaths true
      - name: Install prerequisites (Linux)
        if: matrix.platform == 'linux'
        shell: bash
        run: |
          sudo apt-get update
          sudo apt-get install -y build-essential ninja-build cmake libvulkan-dev vulkan-tools mesa-vulkan-drivers
      - name: Install prerequisites (macOS)
        if: matrix.platform == 'macos'
        shell: bash
        run: |
          xcode-select -p
          if ! command -v ninja >/dev/null 2>&1; then
            brew install ninja
          fi
      - name: Install prerequisites (Windows)
        if: matrix.platform == 'windows'
        shell: pwsh
        run: |
          if (-not (Get-Command ninja -ErrorAction SilentlyContinue)) {
            choco install ninja --no-progress -y
          } else {
            Write-Host "ninja already installed"
          }
          $vulkanSdk = $env:VULKAN_SDK
          if ([string]::IsNullOrWhiteSpace($vulkanSdk)) {
            Write-Host "VULKAN_SDK is not set, installing Vulkan SDK."
            choco install vulkan-sdk --no-progress -y
          } elseif (-not (Test-Path $vulkanSdk)) {
            Write-Host "VULKAN_SDK points to '$vulkanSdk' which does not exist. Reinstalling."
            choco install vulkan-sdk --no-progress -y
          } else {
            Write-Host "Vulkan SDK already present at $vulkanSdk"
          }
      - name: Cache Premake
        uses: actions/cache@v4
        with:
          path: |
            extern/river-renderer/dependencies/premake-core
            extern/river-renderer/build/dependencies/premake-core
          key: premake-${{ runner.os }}-${{ matrix.config }}-${{ hashFiles('extern/river-renderer/build/build_rive.sh') }}
      - name: Validate toolchain (macOS/Linux)
        if: matrix.platform != 'windows'
        shell: bash
        run: |
          chmod +x scripts/validate-toolchains.sh
          ./scripts/validate-toolchains.sh
      - name: Validate toolchain (Windows)
        if: matrix.platform == 'windows'
        shell: pwsh
        run: |
          Set-ExecutionPolicy -Scope Process -ExecutionPolicy Bypass
          ./scripts/validate-toolchains.ps1 -VerboseOutput
      - name: Build native (macOS)
        if: matrix.platform == 'macos'
        shell: bash
        run: |
          chmod +x scripts/build-macos.sh
          ./scripts/build-macos.sh ${{ matrix.config }}
      - name: Build native (Linux)
        if: matrix.platform == 'linux'
        shell: bash
        run: |
          chmod +x scripts/build-linux.sh
          ./scripts/build-linux.sh ${{ matrix.config }}
      - name: Build native (Windows)
        if: matrix.platform == 'windows'
        shell: pwsh
        run: |
          ./scripts/build-windows.ps1 -Configurations @('${{ matrix.config }}') -SkipManaged
      - name: Upload native artifacts
        if: always()
        uses: actions/upload-artifact@v4
        with:
          name: native-${{ matrix.platform }}-${{ matrix.config }}
          path: dotnet/RiveRenderer/runtimes

  render-validation:
    runs-on: ubuntu-22.04
    needs: native
    continue-on-error: false
    steps:
      - uses: actions/checkout@v4
        with:
          submodules: recursive
      - name: Download native artifacts
        uses: actions/download-artifact@v4
        with:
          pattern: native-linux-*
          path: dotnet/RiveRenderer/runtimes
          merge-multiple: true
      - name: Run render validation
        run: |
          chmod +x scripts/validate-render.sh
          ./scripts/validate-render.sh release

  managed-pack:
    runs-on: ubuntu-22.04
    needs:
      - native
      - render-validation
    continue-on-error: true
    steps:
      - uses: actions/checkout@v4
        with:
          submodules: recursive
      - name: Download native artifacts
        uses: actions/download-artifact@v4
        with:
          pattern: native-*
          path: dotnet/RiveRenderer/runtimes
          merge-multiple: true
      - name: Restore & build managed assets
        run: |
          chmod +x scripts/build-managed.sh
          ./scripts/build-managed.sh -c Release
      - name: Upload NuGet artifacts
        if: always()
        uses: actions/upload-artifact@v4
        with:
          name: nuget-packages
          path: artifacts/nuget
